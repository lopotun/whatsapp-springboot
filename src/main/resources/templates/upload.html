<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Upload - WhatsApp Chat Viewer</title>
</head>
<body>
    <div th:fragment="content">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-upload me-2"></i>Upload WhatsApp Chat
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Upload Options -->
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Upload Options</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="uploadType" id="chatFile" value="chat" checked>
                                            <label class="form-check-label" for="chatFile">
                                                <strong>Chat Text File (.txt)</strong><br>
                                                <small class="text-muted">Upload a WhatsApp chat export text file</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="uploadType" id="zipFile" value="zip">
                                            <label class="form-check-label" for="zipFile">
                                                <strong>ZIP Archive</strong><br>
                                                <small class="text-muted">Upload a ZIP file containing chat text and multimedia files</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload Area -->
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Upload Area</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="upload-area" id="uploadArea">
                                            <i class="bi bi-cloud-upload display-4 text-primary mb-3"></i>
                                            <h5>Drag & Drop Files Here</h5>
                                            <p class="text-muted">or click to browse</p>
                                            <input type="file" id="fileInput" accept=".txt,.zip" style="display: none;">
                                        </div>
                                        <div class="mt-3">
                                            <small class="text-muted">
                                                <strong>Supported formats:</strong><br>
                                                • WhatsApp chat export (.txt)<br>
                                                • ZIP archives with multimedia files
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Section -->
                        <div id="progressSection" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-arrow-clockwise me-2"></i>Processing Progress
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="progress mb-3">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" style="width: 0%" id="progressBar">0%</div>
                                    </div>
                                    <div id="progressText" class="text-muted">Preparing upload...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Results Section -->
                        <div id="resultsSection" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-check-circle me-2"></i>Upload Results
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="resultsContent"></div>
                                    <div class="mt-3">
                                        <button class="btn btn-primary" onclick="resetUpload()">
                                            <i class="bi bi-plus-circle me-2"></i>Upload Another File
                                        </button>
                                        <a href="/search" class="btn btn-outline-primary ms-2">
                                            <i class="bi bi-search me-2"></i>Search Messages
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:fragment="scripts">
        <script>
            let currentUploadType = 'chat';
            let isUploading = false;

            // Initialize upload functionality
            document.addEventListener('DOMContentLoaded', function() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const uploadTypeRadios = document.querySelectorAll('input[name="uploadType"]');

                // Handle upload type changes
                uploadTypeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        currentUploadType = this.value;
                        updateFileInputAccept();
                    });
                });

                // Handle drag and drop
                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('dragleave', handleDragLeave);
                uploadArea.addEventListener('drop', handleDrop);

                // Handle file selection
                fileInput.addEventListener('change', handleFileSelect);

                // Initialize file input accept
                updateFileInputAccept();
            });

            function updateFileInputAccept() {
                const fileInput = document.getElementById('fileInput');
                if (currentUploadType === 'zip') {
                    fileInput.accept = '.zip';
                } else {
                    fileInput.accept = '.txt';
                }
            }

            function handleDragOver(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.add('dragover');
            }

            function handleDragLeave(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.remove('dragover');
            }

            function handleDrop(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            }

            function handleFileSelect(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            }

            function handleFile(file) {
                if (isUploading) return;

                // Validate file type
                const isValidType = currentUploadType === 'zip' ? 
                    file.name.toLowerCase().endsWith('.zip') :
                    file.name.toLowerCase().endsWith('.txt');

                if (!isValidType) {
                    Utils.showAlert(`Please select a valid ${currentUploadType === 'zip' ? 'ZIP' : 'TXT'} file.`, 'warning');
                    return;
                }

                // Start upload
                uploadFile(file);
            }

            function uploadFile(file) {
                isUploading = true;
                
                // Show progress section
                document.getElementById('progressSection').style.display = 'block';
                document.getElementById('resultsSection').style.display = 'none';
                
                const formData = new FormData();
                formData.append('file', file);

                const endpoint = currentUploadType === 'zip' ? '/api/chat/upload-zip' : '/api/chat/upload';
                
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        updateProgress(percentComplete, 'Uploading file...');
                    }
                });

                xhr.addEventListener('load', function() {
                    if (xhr.status === 200) {
                        updateProgress(100, 'Processing complete!');
                        setTimeout(() => {
                            showResults(xhr.responseText, file.name);
                        }, 1000);
                    } else {
                        Utils.showAlert('Upload failed: ' + xhr.statusText, 'danger');
                        resetUpload();
                    }
                });

                xhr.addEventListener('error', function() {
                    Utils.showAlert('Upload failed. Please try again.', 'danger');
                    resetUpload();
                });

                xhr.open('POST', endpoint);
                xhr.send(formData);
            }

            function updateProgress(percent, text) {
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                
                progressBar.style.width = percent + '%';
                progressBar.textContent = Math.round(percent) + '%';
                progressText.textContent = text;
            }

            function showResults(responseText, fileName) {
                const resultsSection = document.getElementById('resultsSection');
                const resultsContent = document.getElementById('resultsContent');
                
                // Parse NDJSON response
                const lines = responseText.trim().split('\n');
                const entries = [];
                let extractedFiles = [];
                
                lines.forEach(line => {
                    if (line.trim()) {
                        if (line.includes('Extracted') && line.includes('multimedia files:')) {
                            // This is the summary line
                            return;
                        } else if (line.startsWith('/') || line.includes('.')) {
                            // This is an extracted file path
                            extractedFiles.push(line.trim());
                        } else {
                            try {
                                const entry = JSON.parse(line);
                                entries.push(entry);
                            } catch (e) {
                                // Skip invalid JSON lines
                            }
                        }
                    }
                });

                let html = `
                    <div class="alert alert-success">
                        <h6><i class="bi bi-check-circle me-2"></i>Upload Successful!</h6>
                        <p class="mb-0">File: <strong>${fileName}</strong></p>
                    </div>
                `;

                if (entries.length > 0) {
                    html += `
                        <div class="mb-3">
                            <h6>Processed ${entries.length} chat entries</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted">First entry:</small><br>
                                    <strong>${entries[0].author}</strong> - ${Utils.formatDate(entries[0].timestamp)}
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">Last entry:</small><br>
                                    <strong>${entries[entries.length - 1].author}</strong> - ${Utils.formatDate(entries[entries.length - 1].timestamp)}
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (extractedFiles.length > 0) {
                    html += `
                        <div class="mb-3">
                            <h6>Extracted ${extractedFiles.length} multimedia files</h6>
                            <div class="small text-muted">
                                ${extractedFiles.slice(0, 5).join('<br>')}
                                ${extractedFiles.length > 5 ? '<br>... and ' + (extractedFiles.length - 5) + ' more' : ''}
                            </div>
                        </div>
                    `;
                }

                resultsContent.innerHTML = html;
                resultsSection.style.display = 'block';
                document.getElementById('progressSection').style.display = 'none';
                
                isUploading = false;
            }

            function resetUpload() {
                document.getElementById('fileInput').value = '';
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'none';
                document.getElementById('uploadArea').classList.remove('dragover');
                isUploading = false;
            }
        </script>
    </div>
</body>
</html> 